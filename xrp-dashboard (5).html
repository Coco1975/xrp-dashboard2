<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>XRP Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#080c12; --bg2:#0d1420; --bg3:#111b2d; --border:#1e2f4a;
  --accent:#00c8ff; --accent2:#0077aa; --green:#00e8a0; --red:#ff3d6b;
  --yellow:#ffd24d; --orange:#ff7b54; --text:#c8ddf0; --muted:#4a6a8a;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Rajdhani',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column;}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,200,255,0.01) 2px,rgba(0,200,255,0.01) 4px);pointer-events:none;z-index:9999;}

/* HEADER */
header{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:10px 20px;border-bottom:1px solid var(--border);background:linear-gradient(90deg,#080c12,#0d1a2e,#080c12);position:relative;}
header::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);}
.logo{display:flex;align-items:center;gap:10px;}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'Share Tech Mono',monospace;font-size:12px;font-weight:700;color:#fff;box-shadow:0 0 14px rgba(0,200,255,0.45);letter-spacing:-1px;}
.logo-text{font-size:20px;font-weight:700;letter-spacing:4px;color:var(--accent);text-shadow:0 0 18px rgba(0,200,255,0.5);}
.logo-sub{font-size:10px;letter-spacing:3px;color:var(--muted);font-family:'Share Tech Mono',monospace;margin-top:-2px;}
.hstats{display:flex;gap:22px;align-items:center;}
.hstat{text-align:center;}
.hstat-lbl{font-size:9px;letter-spacing:2px;color:var(--muted);font-family:'Share Tech Mono',monospace;}
.hstat-val{font-size:16px;font-weight:700;}
.up{color:var(--green);} .down{color:var(--red);} .neutral{color:var(--accent);}
.htime{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--muted);text-align:right;line-height:1.7;}
.live-dot{display:inline-block;width:7px;height:7px;background:var(--green);border-radius:50%;margin-right:5px;animation:blink 1.5s infinite;box-shadow:0 0 7px var(--green);}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.15}}

/* LAYOUT */
.layout{flex:1;display:grid;grid-template-columns:1fr 300px;min-height:0;overflow:hidden;}

/* CHART */
.chart-area{display:flex;flex-direction:column;border-right:1px solid var(--border);min-width:0;}
.chart-ctrl{flex-shrink:0;display:flex;align-items:center;gap:6px;padding:7px 14px;background:var(--bg3);border-bottom:1px solid var(--border);flex-wrap:wrap;}
.tf-lbl{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--muted);margin-right:2px;}
.tf-btn{font-family:'Share Tech Mono',monospace;font-size:11px;padding:3px 9px;background:transparent;border:1px solid var(--border);color:var(--muted);cursor:pointer;letter-spacing:1px;border-radius:3px;transition:all .2s;}
.tf-btn:hover,.tf-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(0,200,255,0.07);box-shadow:0 0 8px rgba(0,200,255,0.2);}
.legend{margin-left:auto;display:flex;gap:12px;}
.leg{display:flex;align-items:center;gap:4px;}
.leg-line{width:16px;height:2px;border-radius:2px;}
.leg-txt{font-family:'Share Tech Mono',monospace;font-size:10px;}
.chart-wrap{flex:1;position:relative;min-height:0;background:var(--bg2);cursor:crosshair;overflow:hidden;}
canvas{display:block;position:absolute;top:0;left:0;}
#tip{position:absolute;background:rgba(13,20,32,0.95);border:1px solid var(--border);border-radius:4px;padding:6px 10px;font-family:'Share Tech Mono',monospace;font-size:11px;line-height:1.8;color:var(--text);pointer-events:none;display:none;z-index:10;}
#loading{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;font-family:'Share Tech Mono',monospace;font-size:13px;letter-spacing:3px;color:var(--muted);background:var(--bg2);z-index:20;}
.spinner{width:32px;height:32px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* RIGHT */
.right{display:flex;flex-direction:column;overflow-y:auto;overflow-x:hidden;background:var(--bg2);}
.right::-webkit-scrollbar{width:4px;}
.right::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.ptitle{font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--muted);padding:9px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--bg3);flex-shrink:0;}
.ptitle .pname{color:var(--accent);}
.ptitle .psub{color:var(--muted);font-size:9px;}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);}
.sc{background:var(--bg2);padding:10px 12px;}
.slbl{font-size:9px;letter-spacing:2px;color:var(--muted);font-family:'Share Tech Mono',monospace;margin-bottom:3px;}
.sval{font-size:15px;font-weight:700;color:var(--text);}
.sig-row{display:flex;align-items:center;justify-content:space-between;padding:7px 14px;border-bottom:1px solid rgba(30,47,74,0.5);}
.sig-name{color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:1px;}
.badge{font-size:10px;font-family:'Share Tech Mono',monospace;padding:2px 7px;border-radius:2px;letter-spacing:1px;}
.bull{background:rgba(0,232,160,0.15);color:var(--green);border:1px solid rgba(0,232,160,0.3);}
.bear{background:rgba(255,61,107,0.15);color:var(--red);border:1px solid rgba(255,61,107,0.3);}
.neut{background:rgba(255,210,77,0.15);color:var(--yellow);border:1px solid rgba(255,210,77,0.3);}
.fg-wrap{padding:10px 14px 14px;}
.fg-num{text-align:center;font-size:28px;font-weight:700;color:var(--yellow);}
.fg-lbl{text-align:center;font-size:10px;letter-spacing:2px;color:var(--muted);font-family:'Share Tech Mono',monospace;margin-top:2px;}
.fg-bar{height:7px;border-radius:4px;background:linear-gradient(90deg,var(--red),var(--yellow) 50%,var(--green));position:relative;margin:10px 0 4px;}
.fg-needle{position:absolute;top:-4px;width:3px;height:15px;background:#fff;border-radius:2px;transform:translateX(-50%);box-shadow:0 0 7px rgba(255,255,255,.9);transition:left 1s ease;}
.fg-ends{display:flex;justify-content:space-between;font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace;}
.notes{width:100%;background:var(--bg3);border:none;border-top:1px solid var(--border);color:var(--text);font-family:'Share Tech Mono',monospace;font-size:11px;line-height:1.7;padding:10px 14px;resize:none;outline:none;height:80px;}
.notes::placeholder{color:var(--muted);}
.news-list{overflow-y:auto;padding:6px;min-height:100px;}
.news-list::-webkit-scrollbar{width:3px;}
.news-list::-webkit-scrollbar-thumb{background:var(--border);}
.nitem{padding:8px 10px;border:1px solid var(--border);border-radius:4px;margin-bottom:5px;background:var(--bg3);position:relative;overflow:hidden;transition:all .2s;}
.nitem::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--accent);opacity:0;transition:.2s;}
.nitem:hover{border-color:var(--accent2);background:rgba(0,200,255,0.04);}
.nitem:hover::before{opacity:1;}
.nitem a{color:var(--text);text-decoration:none;font-size:12px;font-weight:500;line-height:1.4;display:block;}
.nitem a:hover{color:var(--accent);}
.nmeta{display:flex;gap:6px;align-items:center;margin-bottom:3px;flex-wrap:wrap;}
.nsrc{font-size:9px;font-family:'Share Tech Mono',monospace;color:var(--accent);letter-spacing:1px;}
.ntype{font-size:8px;font-family:'Share Tech Mono',monospace;padding:1px 5px;border-radius:2px;letter-spacing:1px;}
.t-news{background:rgba(0,200,255,0.15);color:var(--accent);border:1px solid rgba(0,200,255,0.3);}
.t-social{background:rgba(0,232,160,0.15);color:var(--green);border:1px solid rgba(0,232,160,0.3);}
.t-analysis{background:rgba(255,210,77,0.15);color:var(--yellow);border:1px solid rgba(255,210,77,0.3);}
.ndate{font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace;margin-left:auto;}
.ndel{position:absolute;top:5px;right:5px;width:16px;height:16px;background:rgba(255,61,107,0.15);border:1px solid rgba(255,61,107,0.3);border-radius:2px;display:none;align-items:center;justify-content:center;cursor:pointer;font-size:9px;color:var(--red);z-index:2;}
.nitem:hover .ndel{display:flex;}
.add-btn{display:flex;align-items:center;gap:5px;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--accent);background:transparent;border:1px dashed var(--accent2);padding:4px 10px;border-radius:3px;cursor:pointer;transition:all .2s;}
.add-btn:hover{background:rgba(0,200,255,0.07);border-color:var(--accent);}

/* MODAL */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(8,12,18,.88);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-bg.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--accent);border-radius:8px;padding:26px;width:min(400px,92vw);box-shadow:0 0 40px rgba(0,200,255,0.15);animation:mIn .25s ease;}
@keyframes mIn{from{transform:translateY(-18px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal h3{font-size:14px;letter-spacing:3px;color:var(--accent);margin-bottom:18px;font-family:'Share Tech Mono',monospace;}
.fgrp{margin-bottom:12px;}
.fgrp label{display:block;font-size:10px;letter-spacing:2px;color:var(--muted);font-family:'Share Tech Mono',monospace;margin-bottom:5px;}
.fgrp input,.fgrp select{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:9px 11px;font-family:'Share Tech Mono',monospace;font-size:12px;border-radius:4px;outline:none;transition:border-color .2s;}
.fgrp input:focus,.fgrp select:focus{border-color:var(--accent);}
.fgrp select option{background:var(--bg3);}
.mbtns{display:flex;gap:8px;margin-top:18px;justify-content:flex-end;}
.btn{padding:7px 18px;font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:2px;border-radius:4px;cursor:pointer;transition:all .2s;border:1px solid;}
.btn-p{background:var(--accent);border-color:var(--accent);color:#000;font-weight:700;}
.btn-p:hover{background:#00a8d8;}
.btn-g{background:transparent;border-color:var(--border);color:var(--muted);}
.btn-g:hover{border-color:var(--muted);color:var(--text);}

@media(max-width:700px){
  body{height:auto;overflow:auto;}
  .layout{grid-template-columns:1fr;grid-template-rows:55vh auto;overflow-y:auto;}
  .chart-area{border-right:none;border-bottom:1px solid var(--border);}
  .right{overflow-y:visible;}
  .hstats{display:none;}
}
</style>
</head>
<body>
<header>
  <div class="logo">
    <div class="logo-icon">XRP</div>
    <div>
      <div class="logo-text">XRP</div>
      <div class="logo-sub">COMMAND CENTER</div>
    </div>
  </div>
  <div class="hstats">
    <div class="hstat"><div class="hstat-lbl">PRICE</div><div class="hstat-val neutral" id="h-price">—</div></div>
    <div class="hstat"><div class="hstat-lbl">24H CHANGE</div><div class="hstat-val neutral" id="h-chg">—</div></div>
    <div class="hstat"><div class="hstat-lbl">24H HIGH</div><div class="hstat-val up" id="h-high">—</div></div>
    <div class="hstat"><div class="hstat-lbl">24H LOW</div><div class="hstat-val down" id="h-low">—</div></div>
    <div class="hstat"><div class="hstat-lbl">VOLUME</div><div class="hstat-val neutral" id="h-vol">—</div></div>
  </div>
  <div class="htime">
    <div><span class="live-dot"></span><span id="clock">--:--:--</span></div>
    <div id="cdate" style="font-size:10px;"></div>
  </div>
</header>

<div class="layout">
  <!-- CHART -->
  <div class="chart-area">
    <div class="chart-ctrl">
      <span class="tf-lbl">TF:</span>
      <button class="tf-btn" onclick="setTF(this,'60',120)">1H</button>
      <button class="tf-btn" onclick="setTF(this,'240',120)">4H</button>
      <button class="tf-btn active" onclick="setTF(this,'1440',30)">1M</button>
      <button class="tf-btn" onclick="setTF(this,'1440',180)">6M</button>
      <button class="tf-btn" onclick="setTF(this,'1440',365)">1Y</button>
      <div class="legend">
        <div class="leg"><div class="leg-line" style="background:#ffd24d"></div><span class="leg-txt" style="color:#ffd24d">EMA20</span></div>
        <div class="leg"><div class="leg-line" style="background:#00c8ff"></div><span class="leg-txt" style="color:#00c8ff">EMA50</span></div>
        <div class="leg"><div class="leg-line" style="background:#ff7b54"></div><span class="leg-txt" style="color:#ff7b54">EMA200</span></div>
      </div>
    </div>
    <div class="chart-wrap" id="wrap">
      <div id="loading"><div class="spinner"></div>LOADING MARKET DATA…</div>
      <canvas id="cv"></canvas>
      <div id="tip"></div>
    </div>
  </div>

  <!-- RIGHT PANELS -->
  <div class="right">
    <!-- Market Stats -->
    <div>
      <div class="ptitle"><span class="pname">MARKET STATS</span><span class="psub">XRP/USD</span></div>
      <div class="stats-grid">
        <div class="sc"><div class="slbl">PRICE</div><div class="sval neutral" id="s-price">—</div></div>
        <div class="sc"><div class="slbl">24H %</div><div class="sval neutral" id="s-chg">—</div></div>
        <div class="sc"><div class="slbl">24H HIGH</div><div class="sval up" id="s-high">—</div></div>
        <div class="sc"><div class="slbl">24H LOW</div><div class="sval down" id="s-low">—</div></div>
        <div class="sc"><div class="slbl">VOLUME</div><div class="sval neutral" id="s-vol">—</div></div>
        <div class="sc"><div class="slbl">MKT CAP</div><div class="sval neutral" id="s-mcap">—</div></div>
      </div>
    </div>
    <!-- Signals -->
    <div>
      <div class="ptitle"><span class="pname">SIGNALS</span></div>
      <div class="sig-row"><span class="sig-name">EMA20 vs EMA50</span><span class="badge neut" id="sig-2050">—</span></div>
      <div class="sig-row"><span class="sig-name">PRICE vs EMA200</span><span class="badge neut" id="sig-200">—</span></div>
      <div class="sig-row"><span class="sig-name">TREND ALIGNMENT</span><span class="badge neut" id="sig-trend">—</span></div>
      <div class="sig-row"><span class="sig-name">FEAR & GREED</span><span class="badge neut" id="sig-fg">—</span></div>
    </div>
    <!-- Fear & Greed -->
    <div>
      <div class="ptitle"><span class="pname">FEAR & GREED INDEX</span></div>
      <div class="fg-wrap">
        <div class="fg-num" id="fg-num">—</div>
        <div class="fg-lbl" id="fg-lbl">LOADING…</div>
        <div class="fg-bar"><div class="fg-needle" id="fg-needle" style="left:50%"></div></div>
        <div class="fg-ends"><span>FEAR</span><span>NEUTRAL</span><span>GREED</span></div>
      </div>
    </div>
    <!-- Notes -->
    <div>
      <div class="ptitle"><span class="pname">TRADE NOTES</span></div>
      <textarea class="notes" id="notes" placeholder="Add your analysis, price targets, ideas… (auto-saved)"></textarea>
    </div>
    <!-- News & Links -->
    <div style="display:flex;flex-direction:column;">
      <div class="ptitle">
        <span class="pname">NEWS & LINKS</span>
        <button class="add-btn" onclick="openModal()">+ ADD LINK</button>
      </div>
      <div class="news-list" id="news-list"></div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-bg" id="modal" onclick="bgClose(event)">
  <div class="modal">
    <h3>// ADD LINK</h3>
    <div class="fgrp"><label>TITLE / HEADLINE</label><input type="text" id="l-title" placeholder="e.g. XRP breaks resistance…"></div>
    <div class="fgrp"><label>URL</label><input type="url" id="l-url" placeholder="https://…"></div>
    <div class="fgrp"><label>SOURCE</label><input type="text" id="l-src" placeholder="e.g. CoinTelegraph, Twitter…"></div>
    <div class="fgrp"><label>TYPE</label>
      <select id="l-type"><option value="news">NEWS</option><option value="social">SOCIAL</option><option value="analysis">ANALYSIS</option></select>
    </div>
    <div class="mbtns">
      <button class="btn btn-g" onclick="closeModal()">CANCEL</button>
      <button class="btn btn-p" onclick="addLink()">ADD LINK</button>
    </div>
  </div>
</div>

<script>
(function(){
'use strict';

// ── CLOCK ────────────────────────────────────────────────────────
function tick(){
  var n=new Date();
  set('clock',n.toLocaleTimeString('en-GB'));
  set('cdate',n.toLocaleDateString('en-GB',{weekday:'short',year:'numeric',month:'short',day:'numeric'}));
}
tick(); setInterval(tick,1000);

function set(id,v){ var e=document.getElementById(id); if(e) e.textContent=v; }
function setC(id,v,cls){ var e=document.getElementById(id); if(e){e.textContent=v; if(cls) e.className=cls;} }
function fmt(n){ return n>=1e9?(n/1e9).toFixed(2)+'B':n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'K':n.toFixed(2); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ── CANVAS CHART ─────────────────────────────────────────────────
var cv, ctx2, wrap;
var candles=[], vS=0, vE=0;
var drag=false, dragX=0, dragVS=0;
var pinchD=0;
var dpr=window.devicePixelRatio||1;
var PAD={t:16,r:62,b:30,vf:0.18};
var C={BG:'#0d1420',GR:'rgba(30,47,74,0.6)',UP:'#00e8a0',DN:'#ff3d6b',
       VU:'rgba(0,232,160,0.2)',VD:'rgba(255,61,107,0.2)',
       E20:'#ffd24d',E50:'#00c8ff',E200:'#ff7b54',
       TXT:'#4a6a8a',CRS:'rgba(0,200,255,0.55)'};

function W(){ return cv.width/dpr; }
function H(){ return cv.height/dpr; }

function initCV(){
  cv=document.getElementById('cv');
  wrap=document.getElementById('wrap');
  if(!cv||!wrap) return;
  ctx2=cv.getContext('2d');
  sizeCV();
  if(window.ResizeObserver){ new ResizeObserver(sizeCV).observe(wrap); }
  else { window.addEventListener('resize',sizeCV); }
  cv.addEventListener('mousemove',onMM);
  cv.addEventListener('mouseleave',onML);
  cv.addEventListener('mousedown',onMD);
  window.addEventListener('mouseup',function(){ drag=false; });
  cv.addEventListener('wheel',onWh,{passive:false});
  cv.addEventListener('touchstart',onTS,{passive:true});
  cv.addEventListener('touchmove',onTM,{passive:false});
  cv.addEventListener('touchend',function(){ drag=false; });
}

function sizeCV(){
  if(!cv||!wrap) return;
  var w=wrap.clientWidth||300, h=wrap.clientHeight||400;
  cv.style.width=w+'px'; cv.style.height=h+'px';
  cv.width=Math.round(w*dpr); cv.height=Math.round(h*dpr);
  ctx2.setTransform(dpr,0,0,dpr,0,0);
  draw();
}

function calcEMA(data,p){
  var n=data.length;
  if(n<p) return new Array(n).fill(null);
  var out=new Array(n).fill(null), sum=0, k=2/(p+1);
  for(var i=0;i<p;i++) sum+=data[i].close;
  var ema=sum/p; out[p-1]=ema;
  for(var i=p;i<n;i++){ ema=data[i].close*k+ema*(1-k); out[i]=ema; }
  return out;
}

function pY(p,mn,mx,pt,ph){ return pt+ph-((p-mn)/(mx-mn))*ph; }
function iX(i){ var cw=W()-PAD.r,cnt=vE-vS; return ((i-vS+0.5)/cnt)*cw; }

function draw(){
  if(!cv||!ctx2||!candles.length) return;
  var w=W(),h=H();
  var vs=Math.max(0,Math.floor(vS)), ve=Math.min(candles.length,Math.ceil(vE));
  if(ve<=vs) return;
  var ph=h*(1-PAD.vf)-PAD.t-PAD.b, voh=h*PAD.vf;
  var pt=PAD.t, vot=h-voh, cw=w-PAD.r;
  var mn=Infinity,mx=-Infinity;
  for(var i=vs;i<ve;i++){ if(candles[i].low<mn)mn=candles[i].low; if(candles[i].high>mx)mx=candles[i].high; }
  var pd=(mx-mn)*0.06; mn-=pd; mx+=pd; if(mx<=mn) mx=mn+0.01;
  var mv=0; for(var i=vs;i<ve;i++) if(candles[i].volume>mv) mv=candles[i].volume; if(!mv)mv=1;

  ctx2.fillStyle=C.BG; ctx2.fillRect(0,0,w,h);

  // Grid
  ctx2.strokeStyle=C.GR; ctx2.lineWidth=0.5;
  ctx2.fillStyle=C.TXT; ctx2.font='10px monospace'; ctx2.textAlign='right';
  for(var g=0;g<=5;g++){
    var gy=pt+(ph/5)*g;
    ctx2.beginPath(); ctx2.moveTo(0,gy); ctx2.lineTo(cw,gy); ctx2.stroke();
    ctx2.fillText((mx-(mx-mn)/5*g).toFixed(4),w-4,gy+3);
  }
  ctx2.strokeStyle=C.GR; ctx2.lineWidth=1;
  ctx2.beginPath(); ctx2.moveTo(0,vot); ctx2.lineTo(cw,vot); ctx2.stroke();

  // Time labels
  var le=Math.max(1,Math.floor((ve-vs)/7));
  ctx2.fillStyle=C.TXT; ctx2.textAlign='center';
  for(var i=vs;i<ve;i+=le){
    var dd=new Date(candles[i].time*1000);
    ctx2.fillText(dd.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}),iX(i),h-6);
  }

  var bw=Math.max(1,(cw/(ve-vs))*0.7);
  var e20=calcEMA(candles,20),e50=calcEMA(candles,50),e200=calcEMA(candles,200);

  function drawLine(arr,col,lw){
    ctx2.strokeStyle=col; ctx2.lineWidth=lw; ctx2.beginPath();
    var st=false;
    for(var i=vs;i<ve;i++){
      if(arr[i]==null) continue;
      var x=iX(i),y=pY(arr[i],mn,mx,pt,ph);
      if(!st){ctx2.moveTo(x,y);st=true;}else ctx2.lineTo(x,y);
    }
    ctx2.stroke();
  }
  drawLine(e200,C.E200,1.8); drawLine(e50,C.E50,1.4); drawLine(e20,C.E20,1.4);

  // Volume
  for(var i=vs;i<ve;i++){
    var c=candles[i], vx=iX(i), vy=vot+voh-(c.volume/mv)*voh*0.88;
    ctx2.fillStyle=c.close>=c.open?C.VU:C.VD;
    ctx2.fillRect(vx-bw/2,vy,bw,vot-vy);
  }

  // Candles
  for(var i=vs;i<ve;i++){
    var c=candles[i],x=iX(i),col=c.close>=c.open?C.UP:C.DN;
    var oY=pY(c.open,mn,mx,pt,ph),cY=pY(c.close,mn,mx,pt,ph);
    var hY=pY(c.high,mn,mx,pt,ph),lY=pY(c.low,mn,mx,pt,ph);
    ctx2.strokeStyle=col; ctx2.lineWidth=1;
    ctx2.beginPath(); ctx2.moveTo(x,hY); ctx2.lineTo(x,lY); ctx2.stroke();
    ctx2.fillStyle=col;
    ctx2.fillRect(x-bw/2,Math.min(oY,cY),bw,Math.max(1,Math.abs(cY-oY)));
  }

  // Last price line
  if(ve>0){
    var lc=candles[ve-1], ly=pY(lc.close,mn,mx,pt,ph);
    var lco=lc.close>=lc.open?C.UP:C.DN;
    ctx2.strokeStyle=lco; ctx2.lineWidth=0.8; ctx2.setLineDash([4,3]);
    ctx2.beginPath(); ctx2.moveTo(0,ly); ctx2.lineTo(cw,ly); ctx2.stroke();
    ctx2.setLineDash([]);
    ctx2.fillStyle=lco; ctx2.fillRect(cw,ly-9,PAD.r,18);
    ctx2.fillStyle='#000'; ctx2.textAlign='center'; ctx2.font='bold 9px monospace';
    ctx2.fillText(lc.close.toFixed(4),cw+PAD.r/2,ly+3);
  }
}

function crosshair(mx,my){
  if(!candles.length) return;
  var w=W(),h=H(),cw=w-PAD.r,cnt=vE-vS;
  var idx=Math.round((mx/cw)*cnt+vS-0.5);
  var ci=Math.max(0,Math.min(candles.length-1,Math.round(idx)));
  draw();
  ctx2.strokeStyle=C.CRS; ctx2.lineWidth=0.8; ctx2.setLineDash([4,3]);
  ctx2.beginPath(); ctx2.moveTo(iX(ci),0); ctx2.lineTo(iX(ci),h); ctx2.stroke();
  ctx2.beginPath(); ctx2.moveTo(0,my); ctx2.lineTo(cw,my); ctx2.stroke();
  ctx2.setLineDash([]);
  var c=candles[ci], up=c.close>=c.open;
  var tip=document.getElementById('tip');
  var dd=new Date(c.time*1000).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
  tip.innerHTML='<b style="color:var(--accent)">'+dd+'</b><br>'
    +'O:<span style="color:'+(up?'#00e8a0':'#ff3d6b')+'"> '+c.open.toFixed(4)+'</span>  '
    +'H:<span style="color:#00e8a0"> '+c.high.toFixed(4)+'</span><br>'
    +'L:<span style="color:#ff3d6b"> '+c.low.toFixed(4)+'</span>  '
    +'C:<span style="color:'+(up?'#00e8a0':'#ff3d6b')+'"> '+c.close.toFixed(4)+'</span><br>'
    +'Vol:<span style="color:var(--muted)"> '+fmt(c.volume)+'</span>';
  tip.style.display='block';
  var tw=170,th=90;
  tip.style.left=(mx+14+tw>w?mx-tw-10:mx+14)+'px';
  tip.style.top=(my+th>h?my-th-4:my+4)+'px';
}

function onMM(e){ if(drag){doDrag(e.clientX);return;} var r=cv.getBoundingClientRect(); crosshair(e.clientX-r.left,e.clientY-r.top); }
function onML(){ document.getElementById('tip').style.display='none'; draw(); }
function onMD(e){ drag=true; dragX=e.clientX; dragVS=vS; }
function doDrag(cx){ var cw=W()-PAD.r,cnt=vE-vS,d=(dragX-cx)/cw*cnt,ns=Math.max(0,Math.min(candles.length-cnt,dragVS+d)); vS=ns; vE=ns+cnt; draw(); }
function onWh(e){
  e.preventDefault();
  var r=cv.getBoundingClientRect(),mx=e.clientX-r.left,cw=W()-PAD.r;
  var piv=(mx/cw)*(vE-vS)+vS;
  var cnt=Math.round((vE-vS)*(e.deltaY>0?1.12:0.88));
  cnt=Math.max(20,Math.min(candles.length,cnt));
  var ns=Math.max(0,Math.min(candles.length-cnt,piv-(mx/cw)*cnt));
  vS=ns; vE=ns+cnt; draw();
}
function onTS(e){
  if(e.touches.length===1){ drag=true; dragX=e.touches[0].clientX; dragVS=vS; }
  else if(e.touches.length===2){ drag=false; pinchD=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY); }
}
function onTM(e){
  e.preventDefault();
  if(e.touches.length===1&&drag){ doDrag(e.touches[0].clientX); }
  else if(e.touches.length===2){
    var nd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
    var cnt=Math.round((vE-vS)*(pinchD/nd)); pinchD=nd;
    cnt=Math.max(20,Math.min(candles.length,cnt));
    var mid=(vS+vE)/2; vS=Math.max(0,mid-cnt/2); vE=Math.min(candles.length,vS+cnt); draw();
  }
}

// ── SIGNALS ──────────────────────────────────────────────────────
function updateSignals(cd){
  if(cd.length<200) return;
  var e20=calcEMA(cd,20),e50=calcEMA(cd,50),e200=calcEMA(cd,200);
  var n=cd.length-1,p=cd[n].close,v20=e20[n],v50=e50[n],v200=e200[n];
  function badge(id,txt,cls){ var e=document.getElementById(id); if(e){e.textContent=txt;e.className='badge '+cls;} }
  badge('sig-2050',v20>v50?'BULL':'BEAR',v20>v50?'bull':'bear');
  badge('sig-200',p>v200?'ABOVE':'BELOW',p>v200?'bull':'bear');
  badge('sig-trend',v20>v50&&v50>v200?'BULL':v20<v50&&v50<v200?'BEAR':'MIXED',
        v20>v50&&v50>v200?'bull':v20<v50&&v50<v200?'bear':'neut');
}

// ── KRAKEN API ───────────────────────────────────────────────────
// Kraken OHLC: interval in minutes. pair=XRPUSD
async function fetchKrakenOHLC(interval, count){
  // Kraken valid intervals (mins): 1,5,15,30,60,240,1440
  // Calculate how far back to fetch with 30% buffer
  var secsBack = count * parseInt(interval) * 60 * 1.3;
  var since = Math.floor(Date.now()/1000 - secsBack);
  var url='https://api.kraken.com/0/public/OHLC?pair=XRPUSD&interval='+interval+'&since='+since;
  var res=await fetch(url);
  if(!res.ok) throw new Error('Kraken OHLC '+res.status);
  var j=await res.json();
  if(j.error&&j.error.length) throw new Error(j.error[0]);
  var key=Object.keys(j.result).find(function(k){return k!=='last';});
  if(!key) throw new Error('No data in response');
  // Each row: [time, open, high, low, close, vwap, volume, count]
  var rows = j.result[key].map(function(r){
    return {time:+r[0],open:+r[1],high:+r[2],low:+r[3],close:+r[4],volume:+r[6]};
  }).sort(function(a,b){return a.time-b.time;});
  // Return only the most recent `count` candles
  return rows.length > count ? rows.slice(rows.length - count) : rows;
}

async function fetchKrakenTicker(){
  var res=await fetch('https://api.kraken.com/0/public/Ticker?pair=XRPUSD');
  if(!res.ok) throw new Error('Kraken ticker '+res.status);
  var j=await res.json();
  if(j.error&&j.error.length) throw new Error(j.error[0]);
  var d=j.result[Object.keys(j.result)[0]];
  // c=last trade, h=high 24h, l=low 24h, v=volume, o=open
  var price=+d.c[0], high=+d.h[1], low=+d.l[1], vol=+d.v[1], open=+d.o;
  var chgPct=((price-open)/open*100);
  return {price:price,high:high,low:low,vol:vol,chgPct:chgPct};
}

async function loadCandles(interval, count){
  var ld=document.getElementById('loading');
  ld.innerHTML='<div class="spinner"></div>LOADING MARKET DATA…';
  ld.style.display='flex';
  try {
    var cd=await fetchKrakenOHLC(String(interval), count);
    candles=cd; vS=0; vE=cd.length;
    ld.style.display='none';
    draw();
    updateSignals(cd);
  } catch(err){
    console.warn('Kraken candles failed:',err.message);
    ld.innerHTML='<div class="spinner"></div>RETRYING…';
    // Try demo data after short delay
    setTimeout(function(){ useDemoData(); ld.style.display='none'; },1500);
  }
}

async function fetchPrice(){
  try{
    var t=await fetchKrakenTicker();
    var up=t.chgPct>=0, sign=up?'+':'';
    setC('h-price','$'+t.price.toFixed(4));
    setC('h-chg',sign+t.chgPct.toFixed(2)+'%','hstat-val '+(up?'up':'down'));
    setC('h-high','$'+t.high.toFixed(4));
    setC('h-low','$'+t.low.toFixed(4));
    setC('h-vol','$'+fmt(t.vol));
    setC('s-price','$'+t.price.toFixed(4),'sval '+(up?'up':'down'));
    setC('s-chg',sign+t.chgPct.toFixed(2)+'%','sval '+(up?'up':'down'));
    setC('s-high','$'+t.high.toFixed(4),'sval up');
    setC('s-low','$'+t.low.toFixed(4),'sval down');
    setC('s-vol','$'+fmt(t.vol),'sval neutral');
    setC('s-mcap','—','sval neutral');
  } catch(e){ /* silent */ }
}

function useDemoData(){
  var cd=[],p=0.55,now=Math.floor(Date.now()/1000);
  for(var i=400;i>=0;i--){
    var drift=(Math.random()-0.47)*0.038,o=p;
    p=Math.max(0.14,p*(1+drift));
    var hi=Math.max(o,p)*(1+Math.random()*0.017),lo=Math.min(o,p)*(1-Math.random()*0.017);
    cd.push({time:now-i*86400,open:o,high:hi,low:lo,close:p,volume:Math.random()*6e8+1e8});
  }
  candles=cd; vS=0; vE=cd.length; draw(); updateSignals(cd);
}

function setTF(btn,interval,count){
  document.querySelectorAll('.tf-btn').forEach(function(b){b.classList.remove('active');});
  btn.classList.add('active');
  loadCandles(interval,count);
}

// ── FEAR & GREED ─────────────────────────────────────────────────
async function fetchFG(){
  try{
    var r=await fetch('https://api.alternative.me/fng/?limit=1');
    if(!r.ok) throw 0;
    var d=await r.json();
    var val=+d.data[0].value, lbl=d.data[0].value_classification;
    set('fg-num',val); set('fg-lbl',lbl.toUpperCase());
    document.getElementById('fg-needle').style.left=val+'%';
    var fe=document.getElementById('fg-num');
    fe.style.color=val<=25?'#ff3d6b':val<=45?'#ff7b54':val<=55?'#ffd24d':val<=75?'#00c8ff':'#00e8a0';
    var sf=document.getElementById('sig-fg');
    sf.textContent=val+' – '+lbl.split(' ')[0].toUpperCase();
    sf.className='badge '+(val<40?'bear':val>60?'bull':'neut');
  } catch(e){ set('fg-lbl','UNAVAILABLE'); }
}

// ── LINKS ────────────────────────────────────────────────────────
var DEF=[
  {title:'XRP News – CoinTelegraph',url:'https://cointelegraph.com/tags/xrp',src:'CoinTelegraph',type:'news',date:'PINNED'},
  {title:'XRP on CoinGecko',url:'https://www.coingecko.com/en/coins/xrp',src:'CoinGecko',type:'analysis',date:'PINNED'},
  {title:'Ripple Official Blog',url:'https://ripple.com/insights/',src:'Ripple.com',type:'news',date:'PINNED'},
  {title:'XRP on Reddit',url:'https://www.reddit.com/r/XRP/',src:'Reddit',type:'social',date:'PINNED'},
  {title:'XRP Charts – TradingView',url:'https://www.tradingview.com/symbols/XRPUSD/',src:'TradingView',type:'analysis',date:'PINNED'},
  {title:'XRP Twitter / X Search',url:'https://twitter.com/search?q=%24XRP&src=typed_query&f=live',src:'Twitter/X',type:'social',date:'PINNED'},
];
function getLinks(){ try{ var s=JSON.parse(localStorage.getItem('xrp_links')); return(s&&s.length)?s:DEF; }catch(e){ return DEF; } }
function saveLinks(a){ try{ localStorage.setItem('xrp_links',JSON.stringify(a)); }catch(e){} }
function renderLinks(){
  var links=getLinks(), el=document.getElementById('news-list'); el.innerHTML='';
  links.forEach(function(lk,i){
    var d=document.createElement('div'); d.className='nitem';
    d.innerHTML='<div class="nmeta"><span class="nsrc">'+esc(lk.src)+'</span>'
      +'<span class="ntype t-'+lk.type+'">'+lk.type.toUpperCase()+'</span>'
      +'<span class="ndate">'+esc(lk.date||'')+'</span></div>'
      +'<a href="'+esc(lk.url)+'" target="_blank" rel="noopener noreferrer">'+esc(lk.title)+'</a>'
      +'<div class="ndel" onclick="delLink('+i+')" title="Remove">✕</div>';
    el.appendChild(d);
  });
}
window.delLink=function(i){ var a=getLinks(); a.splice(i,1); saveLinks(a); renderLinks(); };
window.openModal=function(){ document.getElementById('modal').classList.add('open'); setTimeout(function(){document.getElementById('l-title').focus();},60); };
window.closeModal=function(){
  document.getElementById('modal').classList.remove('open');
  ['l-title','l-url','l-src'].forEach(function(id){document.getElementById(id).value='';});
  document.getElementById('l-type').value='news';
};
window.bgClose=function(e){ if(e.target.id==='modal') closeModal(); };
window.addLink=function(){
  var title=document.getElementById('l-title').value.trim();
  var url=document.getElementById('l-url').value.trim();
  var src=document.getElementById('l-src').value.trim()||'Source';
  var type=document.getElementById('l-type').value;
  if(!title||!url){alert('Please enter a title and URL.');return;}
  var a=getLinks();
  a.unshift({title:title,url:url,src:src,type:type,date:new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short'})});
  saveLinks(a); renderLinks(); closeModal();
};

// ── NOTES ────────────────────────────────────────────────────────
var notesEl=document.getElementById('notes');
try{ notesEl.value=localStorage.getItem('xrp_notes')||''; }catch(e){}
notesEl.addEventListener('input',function(){ try{ localStorage.setItem('xrp_notes',notesEl.value); }catch(e){} });

// ── BOOT ─────────────────────────────────────────────────────────
window.addEventListener('load',function(){
  initCV();
  loadCandles('1440',30);   // default: 1 month daily
  fetchPrice();
  fetchFG();
  renderLinks();
  setInterval(fetchPrice,30000);
  setInterval(fetchFG,300000);
});

})();
</script>
</body>
</html>
